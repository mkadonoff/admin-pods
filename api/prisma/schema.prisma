generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlserver"
  url      = env("DATABASE_URL")
}

model DigitalTwin {
  digitalTwinId Int      @id @default(autoincrement())
  name          String   @unique
  description   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  towers        Tower[]
  entities      Entity[]
  
  @@map("DigitalTwin")
}

model Tower {
  towerId       Int      @id @default(autoincrement())
  name          String
  orderIndex    Int      @default(0)
  digitalTwinId Int
  digitalTwin   DigitalTwin @relation(fields: [digitalTwinId], references: [digitalTwinId], onDelete: Cascade)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  floors        Floor[]

  @@map("Tower")
}

model Floor {
  floorId         Int              @id @default(autoincrement())
  name            String
  orderIndex      Int              @default(0)
  towerId         Int
  tower           Tower            @relation(fields: [towerId], references: [towerId], onDelete: Cascade)
  rings           Ring[]
  pods            Pod[]
  layoutSnapshots LayoutSnapshot[]

  @@map("Floor")
}

model Ring {
  ringId      Int    @id @default(autoincrement())
  floorId     Int
  floor       Floor  @relation(fields: [floorId], references: [floorId], onDelete: Cascade)
  name        String
  radiusIndex Int
  slots       Int
  pods        Pod[]

  @@map("Ring")
}

model Pod {
  podId        Int      @id @default(autoincrement())
  floorId      Int
  ringId       Int
  slotIndex    Int
  name         String
  podType      String   @default("standard")
  floor        Floor    @relation(fields: [floorId], references: [floorId], onDelete: NoAction, onUpdate: NoAction)
  ring         Ring     @relation(fields: [ringId], references: [ringId], onDelete: Cascade)
  assignments  PodAssignment[]

  @@unique([ringId, slotIndex])
  @@map("Pod")
}

model Entity {
  entityId           Int      @id @default(autoincrement())
  entityType         String
  displayName        String
  externalSystemId   String?
  content            String?  @db.NText
  digitalTwinId      Int
  digitalTwin        DigitalTwin @relation(fields: [digitalTwinId], references: [digitalTwinId], onDelete: Cascade)
  assignments        PodAssignment[]

  @@unique([digitalTwinId, displayName, entityType])
  @@map("Entity")
}

model PodAssignment {
  assignmentId Int      @id @default(autoincrement())
  podId        Int
  entityId     Int
  roleTag      String?
  createdAt    DateTime @default(now())
  pod          Pod      @relation(fields: [podId], references: [podId], onDelete: Cascade)
  entity       Entity   @relation(fields: [entityId], references: [entityId], onDelete: NoAction, onUpdate: NoAction)

  @@unique([podId, entityId])
  @@map("PodAssignment")
}

model LayoutSnapshot {
  snapshotId Int      @id @default(autoincrement())
  floorId    Int
  jsonLayout String
  createdAt  DateTime @default(now())
  floor      Floor    @relation(fields: [floorId], references: [floorId], onDelete: Cascade)

  @@map("LayoutSnapshot")
}
